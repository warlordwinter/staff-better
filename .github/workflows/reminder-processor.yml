name: Reminder Processor

on:
  # Run every 15 minutes
  schedule:
    - cron: "*/15 * * * *"

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Run in test mode (no actual SMS sent)"
        required: false
        default: false
        type: boolean

jobs:
  process-reminders:
    runs-on: ubuntu-latest

    steps:
      - name: Process Reminders
        env:
          VERCEL_APP_URL: ${{ secrets.VERCEL_APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "🚀 Starting reminder processing..."
          echo "⏰ Current time: $(date)"
          echo "🌐 Target URL: $VERCEL_APP_URL"

          # Make API call to your production Vercel app
          RESPONSE=$(curl -sL -w "\n%{http_code}" -X POST "$VERCEL_APP_URL/api/reminders/process" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json")

          # Extract HTTP status code and response body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)

          echo "📊 HTTP Status: $HTTP_CODE"
          echo "📊 Response Body:"
          echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"

          # Check if the request was successful
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ API call successful"
            
            # Parse JSON response if possible
            if echo "$RESPONSE_BODY" | jq -e '.success == true' > /dev/null 2>&1; then
              echo "✅ Reminder processing completed successfully"
              PROCESSED=$(echo "$RESPONSE_BODY" | jq -r '.processed // 0')
              SUCCESSFUL=$(echo "$RESPONSE_BODY" | jq -r '.successful // 0')
              FAILED=$(echo "$RESPONSE_BODY" | jq -r '.failed // 0')
              echo "📈 Results: Processed=$PROCESSED, Successful=$SUCCESSFUL, Failed=$FAILED"
            else
              echo "⚠️ API returned success but reminder processing may have failed"
              echo "$RESPONSE_BODY"
            fi
          else
            echo "❌ API call failed with status $HTTP_CODE"
            echo "$RESPONSE_BODY"
            exit 1
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## Reminder Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target URL**: ${{ secrets.VERCEL_APP_URL }}" >> $GITHUB_STEP_SUMMARY
