name: Deploy Lambda Function

on:
  push:
    paths:
      - "infrastructure/lambda/reminder-processor/**"
      - "infrastructure/lambda/daily-summary-email/**"
      - ".github/workflows/deploy-lambda.yml"
  workflow_dispatch: # Allows manual triggering

env:
  AWS_REGION: us-east-1

jobs:
  deploy-reminder-processor:
    name: Deploy Reminder Processor Lambda
    runs-on: ubuntu-latest
    env:
      LAMBDA_FUNCTION_NAME: ReminderProcessor
      LAMBDA_DIR: infrastructure/lambda/reminder-processor

    permissions:
      id-token: write # Required for OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.LAMBDA_DIR }}/package.json

      - name: Install Lambda dependencies
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          npm ci --omit=dev
          echo "Dependencies installed successfully"

      - name: Create deployment package
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          zip -r function.zip index.js node_modules/ -q
          echo "Package size: $(du -h function.zip | cut -f1)"

          # Check package size (Lambda limit is 50MB uncompressed)
          PACKAGE_SIZE=$(du -m function.zip | cut -f1)
          if [ $PACKAGE_SIZE -gt 45 ]; then
            echo "‚ö†Ô∏è Warning: Package size is ${PACKAGE_SIZE}MB, close to 50MB limit"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Lambda
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          echo "Deploying Lambda function: ${{ env.LAMBDA_FUNCTION_NAME }}"
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Lambda function code updated successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for Lambda deployment to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          echo "‚úÖ Deployment completed"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          LAST_MODIFIED=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastModified' \
            --output text)

          echo "‚úÖ Lambda function last modified: $LAST_MODIFIED"

          # Get function version
          VERSION=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.Version' \
            --output text)

          echo "üì¶ Function version: $VERSION"

      - name: Cleanup
        if: always()
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          rm -f function.zip
          echo "Cleaned up deployment package"

  deploy-daily-summary:
    name: Deploy Daily Summary Email Lambda
    runs-on: ubuntu-latest
    env:
      LAMBDA_FUNCTION_NAME: DailySummaryEmail
      LAMBDA_DIR: infrastructure/lambda/daily-summary-email

    permissions:
      id-token: write # Required for OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.LAMBDA_DIR }}/package.json

      - name: Install Lambda dependencies
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          npm ci --omit=dev
          echo "Dependencies installed successfully"

      - name: Create deployment package
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          zip -r function.zip index.js emailTemplate.js node_modules/ -q
          echo "Package size: $(du -h function.zip | cut -f1)"

          # Check package size (Lambda limit is 50MB uncompressed)
          PACKAGE_SIZE=$(du -m function.zip | cut -f1)
          if [ $PACKAGE_SIZE -gt 45 ]; then
            echo "‚ö†Ô∏è Warning: Package size is ${PACKAGE_SIZE}MB, close to 50MB limit"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Lambda
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          echo "Deploying Lambda function: ${{ env.LAMBDA_FUNCTION_NAME }}"
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Lambda function code updated successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for Lambda deployment to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          echo "‚úÖ Deployment completed"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          LAST_MODIFIED=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastModified' \
            --output text)

          echo "‚úÖ Lambda function last modified: $LAST_MODIFIED"

          # Get function version
          VERSION=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.Version' \
            --output text)

          echo "üì¶ Function version: $VERSION"

      - name: Cleanup
        if: always()
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          rm -f function.zip
          echo "Cleaned up deployment package"
