name: Deploy Lambda Function

on:
  push:
    paths:
      - "infrastructure/lambda/reminder-processor/**"
      - "infrastructure/lambda/daily-summary-email/**"
      - "infrastructure/cloudformation/**"
      - ".github/workflows/deploy-lambda.yml"
  workflow_dispatch: # Allows manual triggering

env:
  AWS_REGION: us-east-1
  STACK_NAME: reminder-scheduler-stack
  CLOUDFORMATION_TEMPLATE: infrastructure/cloudformation/reminder-scheduler-stack.yaml

jobs:
  deploy-cloudformation:
    name: Deploy CloudFormation Stack
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if stack exists
        id: check-stack
        run: |
          if aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Stack exists, will update"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Stack does not exist, will create"
          fi

      - name: Deploy CloudFormation Stack (Create)
        if: steps.check-stack.outputs.exists == 'false'
        run: |
          echo "Creating CloudFormation stack..."
          aws cloudformation create-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://${{ env.CLOUDFORMATION_TEMPLATE }} \
            --parameters \
              ParameterKey=TwilioAccountSid,ParameterValue=${{ secrets.TWILIO_ACCOUNT_SID }} \
              ParameterKey=TwilioAuthToken,ParameterValue=${{ secrets.TWILIO_AUTH_TOKEN }} \
              ParameterKey=TwilioDefaultFrom,ParameterValue=${{ secrets.TWILIO_DEFAULT_FROM }} \
              ParameterKey=SupabaseUrl,ParameterValue=${{ secrets.SUPABASE_URL }} \
              ParameterKey=SupabaseServiceRoleKey,ParameterValue=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} \
              ParameterKey=SesFromEmail,ParameterValue=${{ secrets.SES_FROM_EMAIL }} \
              ParameterKey=ApiBaseUrl,ParameterValue=${{ secrets.API_BASE_URL }} \
              ParameterKey=CronSecret,ParameterValue=${{ secrets.CRON_SECRET }} \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_NAMED_IAM

          echo "Waiting for stack creation to complete..."
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Stack created successfully"

      - name: Deploy CloudFormation Stack (Update)
        if: steps.check-stack.outputs.exists == 'true'
        run: |
          echo "Updating CloudFormation stack..."
          aws cloudformation update-stack \
            --stack-name ${{ env.STACK_NAME }} \
            --template-body file://${{ env.CLOUDFORMATION_TEMPLATE }} \
            --parameters \
              ParameterKey=TwilioAccountSid,UsePreviousValue=true \
              ParameterKey=TwilioAuthToken,UsePreviousValue=true \
              ParameterKey=TwilioDefaultFrom,UsePreviousValue=true \
              ParameterKey=SupabaseUrl,UsePreviousValue=true \
              ParameterKey=SupabaseServiceRoleKey,UsePreviousValue=true \
              ParameterKey=SesFromEmail,ParameterValue=${{ secrets.SES_FROM_EMAIL }} \
              ParameterKey=ApiBaseUrl,ParameterValue=${{ secrets.API_BASE_URL }} \
              ParameterKey=CronSecret,ParameterValue=${{ secrets.CRON_SECRET }} \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_NAMED_IAM || EXIT_CODE=$?

          # Exit code 255 means no updates are to be performed, which is OK
          if [ "${EXIT_CODE:-0}" = "255" ]; then
            echo "‚ÑπÔ∏è No stack updates detected"
          else
            echo "Waiting for stack update to complete..."
            aws cloudformation wait stack-update-complete \
              --stack-name ${{ env.STACK_NAME }} \
              --region ${{ env.AWS_REGION }}
            echo "‚úÖ Stack updated successfully"
          fi

      - name: Get stack outputs
        run: |
          echo "üìã Stack Outputs:"
          aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output table

  deploy-reminder-processor:
    name: Deploy Reminder Processor Lambda
    runs-on: ubuntu-latest
    needs: deploy-cloudformation
    if: always() && (needs.deploy-cloudformation.result == 'success' || needs.deploy-cloudformation.result == 'skipped')
    env:
      LAMBDA_FUNCTION_NAME: ReminderProcessor
      LAMBDA_DIR: infrastructure/lambda/reminder-processor

    permissions:
      id-token: write # Required for OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.LAMBDA_DIR }}/package.json

      - name: Install Lambda dependencies
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          npm ci --omit=dev
          echo "Dependencies installed successfully"

      - name: Create deployment package
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          zip -r function.zip index.js node_modules/ -q
          echo "Package size: $(du -h function.zip | cut -f1)"

          # Check package size (Lambda limit is 50MB uncompressed)
          PACKAGE_SIZE=$(du -m function.zip | cut -f1)
          if [ $PACKAGE_SIZE -gt 45 ]; then
            echo "‚ö†Ô∏è Warning: Package size is ${PACKAGE_SIZE}MB, close to 50MB limit"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Lambda
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          echo "Deploying Lambda function: ${{ env.LAMBDA_FUNCTION_NAME }}"
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Lambda function code updated successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for Lambda deployment to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          echo "‚úÖ Deployment completed"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          LAST_MODIFIED=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastModified' \
            --output text)

          echo "‚úÖ Lambda function last modified: $LAST_MODIFIED"

          # Get function version
          VERSION=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.Version' \
            --output text)

          echo "üì¶ Function version: $VERSION"

      - name: Cleanup
        if: always()
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          rm -f function.zip
          echo "Cleaned up deployment package"

  deploy-daily-summary:
    name: Deploy Daily Summary Email Lambda
    runs-on: ubuntu-latest
    needs: deploy-cloudformation
    if: always() && (needs.deploy-cloudformation.result == 'success' || needs.deploy-cloudformation.result == 'skipped')
    env:
      LAMBDA_FUNCTION_NAME: DailySummaryEmail
      LAMBDA_DIR: infrastructure/lambda/daily-summary-email

    permissions:
      id-token: write # Required for OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ env.LAMBDA_DIR }}/package.json

      - name: Install Lambda dependencies
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          npm ci --omit=dev
          echo "Dependencies installed successfully"

      - name: Create deployment package
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          zip -r function.zip index.js emailTemplate.js node_modules/ -q
          echo "Package size: $(du -h function.zip | cut -f1)"

          # Check package size (Lambda limit is 50MB uncompressed)
          PACKAGE_SIZE=$(du -m function.zip | cut -f1)
          if [ $PACKAGE_SIZE -gt 45 ]; then
            echo "‚ö†Ô∏è Warning: Package size is ${PACKAGE_SIZE}MB, close to 50MB limit"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to Lambda
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          echo "Deploying Lambda function: ${{ env.LAMBDA_FUNCTION_NAME }}"
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --zip-file fileb://function.zip \
            --region ${{ env.AWS_REGION }}

          echo "‚úÖ Lambda function code updated successfully"

      - name: Wait for deployment to complete
        run: |
          echo "Waiting for Lambda deployment to complete..."
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}
          echo "‚úÖ Deployment completed"

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          LAST_MODIFIED=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.LastModified' \
            --output text)

          echo "‚úÖ Lambda function last modified: $LAST_MODIFIED"

          # Get function version
          VERSION=$(aws lambda get-function \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Configuration.Version' \
            --output text)

          echo "üì¶ Function version: $VERSION"

      - name: Cleanup
        if: always()
        working-directory: ${{ env.LAMBDA_DIR }}
        run: |
          rm -f function.zip
          echo "Cleaned up deployment package"
